#!/usr/bin/env bash
#
# publish-event.sh - Publish RabbitMQ events for testing async job handlers
#
# Usage:
#   ./publish-event.sh <routing_key> <payload> [message_id] [container_name]
#
# Examples:
#   ./publish-event.sh "acme.event.update" '[123,{"field":["old","new"]}]'
#   ./publish-event.sh "acme.event.update" '[123,{"field":["old","new"]}]' "custom-msg-id"
#   ./publish-event.sh "acme.event.update" '[123,{"field":["old","new"]}]' "" "my-rabbitmq"
#

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default values
EXCHANGE="events"
CONTAINER_NAME="${4:-payments-rabbitmq}"

# Function to print colored messages
print_error() {
    echo -e "${RED}ERROR: $1${NC}" >&2
}

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_info() {
    echo -e "${BLUE}ℹ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

# Function to check if Docker is running
check_docker() {
    if ! docker info > /dev/null 2>&1; then
        print_error "Docker is not running"
        print_info "Please start Docker and try again"
        exit 1
    fi
    print_success "Docker is running"
}

# Function to check if container exists and is running
check_container() {
    local container=$1

    if ! docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
        print_error "Container '${container}' is not running"

        # Check if it exists but is stopped
        if docker ps -a --format '{{.Names}}' | grep -q "^${container}$"; then
            print_info "Container exists but is stopped. Start it with: docker start ${container}"
        else
            print_info "Container does not exist. Available containers:"
            docker ps -a --format "  - {{.Names}}"
        fi
        exit 1
    fi
    print_success "Container '${container}' is running"
}

# Function to validate JSON
validate_json() {
    local json=$1

    if ! echo "$json" | jq empty 2>/dev/null; then
        print_error "Invalid JSON payload"
        print_info "Payload must be valid JSON"
        return 1
    fi
    print_success "Payload is valid JSON"
    return 0
}

# Function to validate array payload format
validate_array_payload() {
    local json=$1

    if ! echo "$json" | jq -e 'type == "array"' > /dev/null 2>&1; then
        print_warning "Payload is not an array"
        print_info "Most handlers expect array format: [entityId, changesObject]"
        print_info "Continuing anyway - some handlers use object format"
        return 0
    fi

    local length=$(echo "$json" | jq 'length')
    if [ "$length" -lt 1 ]; then
        print_error "Array payload is empty"
        return 1
    fi

    print_success "Payload is array format with ${length} element(s)"
    return 0
}

# Function to generate message ID
generate_message_id() {
    local routing_key=$1
    local timestamp=$(date +%s)
    local random=$(openssl rand -hex 4 2>/dev/null || echo $RANDOM)
    echo "${routing_key//\./-}-${timestamp}-${random}"
}

# Function to format JSON for display
format_json() {
    local json=$1
    echo "$json" | jq -C '.' 2>/dev/null || echo "$json"
}

# Function to publish event
publish_event() {
    local routing_key=$1
    local payload=$2
    local message_id=$3
    local container=$4

    print_info "Publishing event..."
    echo
    echo "  Exchange:    ${EXCHANGE}"
    echo "  Routing Key: ${routing_key}"
    echo "  Message ID:  ${message_id}"
    echo "  Container:   ${container}"
    echo
    echo "  Payload:"
    format_json "$payload" | sed 's/^/    /'
    echo

    # Construct properties JSON
    local properties=$(jq -n \
        --arg content_type "application/json" \
        --arg message_id "$message_id" \
        '{content_type: $content_type, message_id: $message_id}')

    # Execute publish command
    if docker exec "$container" rabbitmqadmin publish \
        exchange="$EXCHANGE" \
        routing_key="$routing_key" \
        payload="$payload" \
        properties="$properties" 2>&1; then
        echo
        print_success "Event published successfully"
        print_info "Check logs for: AsyncEventId: ${message_id}"
        return 0
    else
        echo
        print_error "Failed to publish event"
        return 1
    fi
}

# Main script
main() {
    # Check arguments
    if [ $# -lt 2 ]; then
        echo "Usage: $0 <routing_key> <payload> [message_id] [container_name]"
        echo
        echo "Examples:"
        echo "  $0 'acme.event.update' '[123,{\"field\":[\"old\",\"new\"]}]'"
        echo "  $0 'acme.event.update' '[123,{\"field\":[\"old\",\"new\"]}]' 'custom-msg-id'"
        echo
        exit 1
    fi

    local routing_key=$1
    local payload=$2
    local message_id=${3:-$(generate_message_id "$routing_key")}

    print_info "RabbitMQ Event Publisher"
    echo

    # Validate environment
    check_docker
    check_container "$CONTAINER_NAME"
    echo

    # Validate payload
    print_info "Validating payload..."
    if ! validate_json "$payload"; then
        exit 1
    fi
    validate_array_payload "$payload"
    echo

    # Publish event
    publish_event "$routing_key" "$payload" "$message_id" "$CONTAINER_NAME"
}

# Run main function
main "$@"
