#!/bin/bash
# Script to truncate all tables in a PostgreSQL database
# This preserves the schema but removes all data

set -e

# Default connection settings
host="${PGHOST:-localhost}"
port="${PGPORT:-5432}"
user="${PGUSER:-postgres}"
password="${PGPASSWORD:-postgres}"
database="${PGDATABASE:-postgres}"
skip_confirm=false

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --database)
            database="$2"
            shift 2
            ;;
        --user)
            user="$2"
            shift 2
            ;;
        --host)
            host="$2"
            shift 2
            ;;
        --port)
            port="$2"
            shift 2
            ;;
        -y|--yes)
            skip_confirm=true
            shift
            ;;
        -h|--help)
            echo "Usage: $(basename "$0") [OPTIONS]"
            echo ""
            echo "Truncates all tables in a PostgreSQL database (localhost only)."
            echo ""
            echo "Options:"
            echo "  --database <name>  Database name (default: \$PGDATABASE or 'postgres')"
            echo "  --user <name>      Database user (default: \$PGUSER or 'postgres')"
            echo "  --host <name>      Database host (default: \$PGHOST or 'localhost')"
            echo "  --port <number>    Database port (default: \$PGPORT or '5432')"
            echo "  -y, --yes          Skip confirmation prompt"
            echo "  -h, --help         Show this help message"
            echo ""
            echo "Environment variables:"
            echo "  PGHOST, PGPORT, PGUSER, PGPASSWORD, PGDATABASE"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Safety check: Only allow running on localhost
if [[ "$host" != "localhost" && "$host" != "127.0.0.1" && "$host" != "::1" ]]; then
    echo "‚ùå ERROR: This script can only run against localhost databases."
    echo "   Current host: ${host}"
    echo "   This is a safety measure to prevent accidental data loss on remote databases."
    exit 1
fi

echo "üóëÔ∏è  Truncating all tables in database: ${database}"
echo "   Host: ${host}:${port}"
echo "   User: ${user}"
echo ""

# Confirm action unless -y flag is set
if [ "$skip_confirm" = false ]; then
    read -p "‚ö†Ô∏è  This will delete ALL data from ALL tables. Continue? (yes/no): " confirm
    if [ "$confirm" != "yes" ]; then
        echo "‚ùå Aborted."
        exit 1
    fi
fi
    exit 1
fi

# Generate and execute truncate commands
PGPASSWORD="${password}" psql -h "${host}" -p "${port}" -U "${user}" -d "${database}" <<EOF
DO \$\$
DECLARE
    r RECORD;
    schema_name TEXT;
    table_count INTEGER := 0;
BEGIN
    -- Disable foreign key checks temporarily
    SET session_replication_role = 'replica';

    -- Truncate tables in each application schema
    FOR schema_name IN
        SELECT nspname
        FROM pg_namespace
        WHERE nspname NOT IN ('pg_catalog', 'information_schema', 'pg_toast')
        ORDER BY nspname
    LOOP
        FOR r IN
            SELECT tablename
            FROM pg_tables
            WHERE schemaname = schema_name
            ORDER BY tablename
        LOOP
            EXECUTE format('TRUNCATE TABLE %I.%I CASCADE', schema_name, r.tablename);
            table_count := table_count + 1;
            RAISE NOTICE 'Truncated %.%', schema_name, r.tablename;
        END LOOP;
    END LOOP;

    -- Re-enable foreign key checks
    SET session_replication_role = 'origin';

    RAISE NOTICE '';
    RAISE NOTICE '‚úÖ Successfully truncated % tables', table_count;
END \$\$;
EOF

echo ""
echo "‚úÖ All tables truncated successfully!"
