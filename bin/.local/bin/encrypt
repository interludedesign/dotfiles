#!/usr/bin/env bash
set -euo pipefail

INPUT_DIR=""
OUTPUT_BASE=""
PUBLIC_KEY=""

print_help() {
  cat <<EOF
encrypt — archive + encrypt a directory using age

Usage:
  encrypt --input <directory> \\
          --output <output_path_without_extension> \\
          --public-key <age1publickey...>

Arguments:
  --input <dir>
      The directory you want to encrypt.
      Example: --input ~/Notes

  --output <path>
      The destination *base path* for the encrypted file.
      The script automatically adds ".tar.age".
      Example: --output ~/Backups/my_notes
      Result:  ~/Backups/my_notes.tar.age

  --public-key <key>
      The age *recipient* public key that encryption targets.
      This must be an "age1..." formatted public key.

  --help
      Show this help text and exit.

Examples:
  encrypt --input ~/Notes --output ~/Backups/notes --public-key age1abcxyz...
EOF
}

# --- required commands ---
for cmd in tar age; do
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "ERROR: required program '$cmd' is not installed or not on PATH."
    exit 1
  fi
done

# --- argument parsing ---
while [[ $# -gt 0 ]]; do
  case "$1" in
    --help)
      print_help
      exit 0
      ;;
    --input)
      INPUT_DIR="$2"
      shift 2
      ;;
    --output)
      OUTPUT_BASE="$2"
      shift 2
      ;;
    --public-key)
      PUBLIC_KEY="$2"
      shift 2
      ;;
    *)
      echo "Unknown option: $1"
      echo "Run: encrypt --help"
      exit 1
      ;;
  esac
done

# --- validation ---
if [[ -z "$INPUT_DIR" ]] || [[ -z "$OUTPUT_BASE" ]] || [[ -z "$PUBLIC_KEY" ]]; then
  echo "Missing arguments."
  echo "Run: encrypt --help"
  exit 1
fi

if [[ ! -d "$INPUT_DIR" ]]; then
  echo "ERROR: input directory does not exist: $INPUT_DIR"
  exit 1
fi

# auto extension
OUTPUT_FILE="${OUTPUT_BASE}.tar.age"

mkdir -p "$(dirname "$OUTPUT_FILE")"

PARENT="$(dirname "$INPUT_DIR")"
NAME="$(basename "$INPUT_DIR")"

echo "Encrypting:"
echo "  $INPUT_DIR"
echo "→"
echo "  $OUTPUT_FILE"
echo

# tar + encrypt
tar -C "$PARENT" -cf - "$NAME" \
  | age -r "$PUBLIC_KEY" > "$OUTPUT_FILE"

echo "Done."
